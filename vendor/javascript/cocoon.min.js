/*! Cocoon.js (Turbo-compatible, MIT License) */
(function(){
  function triggerEvent(element, name) {
    var event;
    if (typeof window.CustomEvent === "function") {
      event = new CustomEvent(name, {bubbles: true, cancelable: true});
    } else {
      event = document.createEvent("CustomEvent");
      event.initCustomEvent(name, true, true, {});
    }
    element.dispatchEvent(event);
  }
  document.addEventListener("click", function(e) {
    var addBtn = e.target.closest('[data-association]');
    if (addBtn && addBtn.dataset.association) {
      e.preventDefault();
      var assoc = addBtn.dataset.association;
      var assocId = addBtn.dataset.associationId;
      var content = document.getElementById('template_' + assoc + (assocId ? '_' + assocId : ''));
      if (content) {
        var newId = new Date().getTime();
        var regexp = new RegExp('new_' + assoc, 'g');
        var node = document.createElement('div');
        node.innerHTML = content.innerHTML.replace(regexp, newId);
        var container = addBtn.closest('.links') || addBtn.parentNode;
        container.querySelector('#links').appendChild(node.firstElementChild);
        triggerEvent(container, 'cocoon:after-insert');
      }
    }
    var removeBtn = e.target.closest('.remove_fields');
    if (removeBtn) {
      e.preventDefault();
      var wrapper = removeBtn.closest('.nested-fields');
      if (wrapper) {
        wrapper.remove();
        triggerEvent(document, 'cocoon:after-remove');
      }
    }
  }, false);
})();
